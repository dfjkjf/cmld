---
sort: 1
---

# 内存检测

## 工具

### valgrind

Valgrind 是一种编程工具，主要用于内存调试、内存泄露检测以及性能分析。内存检测通常使用memcheck。

```bash
sudo apt install valgrind
gcc -g -o myprogram myprogram.c
valgrind ./myprogram
```


### mtrace

`mtrace` 和 `muntrace` 是 C 标准库中用于检测内存泄露的工具。它们通过跟踪 `malloc`、`realloc` 和 `free` 调用来帮助识别内存泄露。

1. 代码注入
```c
#include <mcheck.h> // 包含必要的头文件

int main() {
    mtrace();    // 在你的程序开始时，调用 `mtrace()` 函数来初始化内存跟踪
                 // ... 程序的其他部分 ...
    muntrace();  // 在程序结束前，调用 `muntrace()` 函数来关闭内存跟踪
    return 0;
}
```
2. 编译程序时，确保使用 `-g` 选项以便 `mtrace` 可以提供更详细的调试信息。
3. 设置环境变量：在运行程序之前，设置环境变量 `MALLOC_TRACE`，以便 `mtrace` 将跟踪信息写入指定的文件。
```bash
export MALLOC_TRACE=./myprogram.log
```
4. 运行程序
5. 分析跟踪文件：程序运行结束后，使用 `mtrace` 命令来分析 `MALLOC_TRACE` 文件，它会显示内存泄露的报告。
```bash
mtrace ./myprogram ./myprogram.log
```
### 缺点

1. `mtrace` 和 `muntrace` 的使用会增加程序的运行开销；
2. 只能检测通过 `malloc`、`realloc` 和 `free` 分配和释放的内存。如果你使用其他内存分配函数（如 `calloc`、`alloca` 或系统调用），则 `mtrace` 可能无法检测到泄露。
