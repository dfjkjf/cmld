---
sort: 3
---

# RTPS发现模块

- **RTPS发现协议**
   - 参与者发现协议
   - 端点发现协议
- **简单参与者发现协议（SPDP）**
   - 通用方法
   - SPDP发现的参与者数据
   - 内置端点
   - 逻辑端口
- **简单端点发现协议（SEDP）**
   - 通用方法
   - 内置端点
   - 数据类型
   - 与RTPS虚拟机的交互
   - 支持替代发现协议

## 简单参与者发现协议（SPDP）

- **通用方法**
    - 为每个参与者创建两个RTPS内置端点：SPDP内置参与者写入器（SPDPbuiltinParticipantWriter）和SPDP内置参与者读取器（SPDPbuiltinParticipantReader）
    - SPDP内置参与者写入器是一个RTPS尽力而为无状态写入器，其历史缓存包含一个SPDP发现的参与者数据类型的数据对象，通过定期调用无状态写入器的未发送更改重置操作，将此数据对象发送到预配置的定位器列表以宣布参与者在网络上的存在
    - SPDP内置参与者读取器接收来自远程参与者的SPDP发现的参与者数据公告，其中包含远程参与者支持的端点发现协议信息，然后使用适当的端点发现协议与远程参与者交换端点信息
- **SPDPdiscoveredParticipantData**
    - 定义了作为SPDP一部分交换的数据
    - 包含如域标识符、协议版本、参与者的通用前缀、供应商ID等多个属性，以及端点发现协议相关信息、内置端点可用性等
- **内置端点**
    - SPDP内置参与者写入器相关属性包括定位器列表、可靠性级别、主题类型等
    - SPDP内置参与者读取器配置有定位器列表、可靠性级别和主题类型等属性，其历史缓存包含所有活动发现的参与者信息
- **逻辑端口**
    - 每个SPDP内置参与者写入器使用预配置的定位器列表宣布参与者在网络上的存在，这些定位器使用特定的逻辑端口
    - 包括SPDP_WELL_KNOWN_UNICAST_PORT和SPDP_WELL_KNOWN_MULTICAST_PORT，实际值由PSM定义

## 详细介绍下简单端点发现协议（SPDP）的历史缓存功能

SPDP的历史缓存具有以下功能：
### SPDPbuiltinParticipantWriter历史缓存
- **数据对象及更新机制**
    - 历史缓存中包含一个SPDPdiscoveredParticipantData类型的数据对象。
    - 当参与者的属性发生变化时，该数据对象会被替换。
- **数据发送机制**
    - 通过定期调用StatelessWriter::unsent_changes_reset操作，将历史缓存中的数据对象发送到预配置的定位器列表，以宣布参与者在网络上的存在。
### SPDPbuiltinParticipantReader历史缓存
- **信息存储与检索**
    - 历史缓存中包含所有活动发现的参与者信息。
    - 用于识别每个数据对象的键对应于参与者的GUID。
- **数据处理机制**
    - 每次接收到参与者的信息时，SPDP会检查历史缓存，寻找与参与者GUID匹配的条目。如果不存在匹配的条目，则会添加一个以参与者GUID为键的新条目。
    - 定期检查历史缓存，寻找过期的条目（超过其指定的租约期限未更新的条目）并将其删除。

## 简单端点发现协议（SEDP）

- **通用方法**
    - 使用预定义的内置端点，一旦参与者知道另一个参与者的存在，就可以假设存在远程参与者提供的内置端点，并与本地匹配的内置端点建立关联。
    - 用于内置端点之间通信的协议与用于应用程序定义的端点的协议相同。
- **内置端点**
    - SEDP映射与“DCPSSubscription”、“DCPSPublication”和“DCPSTopic”主题相关的DDS内置实体为可靠的RTPS写入器和读取器端点，如SEDP内置发布写入器（SEDPbuiltinPublicationsWriter）和SEDP内置发布读取器（SEDPbuiltinPublicationsReader）等。
    - RTPS协议为这些内置端点保留了特定的EntityId_t值。
- **数据类型**
    - 每个RTPS端点都有一个历史缓存，用于存储与端点相关的数据对象的更改，SEDP的内置端点也依赖于一些数据类型来表示写入其历史缓存的数据的逻辑内容。
    - 定义了如DiscoveredWriterData、DiscoveredReaderData和DiscoveredTopicData等数据类型，这些数据类型包含了DDS为相应内置DDS实体指定的所有信息以及配置RTPS端点可能需要的其他信息。
- **与RTPS虚拟机的交互**
    - 可以使用SPDP提供的信息来配置RTPS虚拟机中的SEDP内置端点。
    - 例如，发现新的远程参与者时，根据相关条件配置本地SEDP内置端点与远程参与者的对应端点进行通信；当判断远程参与者不再存在时，重新配置本地与该远程参与者通信的端点。
- **支持替代发现协议**
    - 允许实现支持多个参与者和端点发现协议，以满足不同的部署场景需求。
    - 所有RTPS实现至少要支持SPDP和SEDP，对于支持多种协议的情况，说明了不同协议的使用条件和交互方式。

## 详细介绍下简单端点发现协议（SEDP）的历史缓存功能

简单端点发现协议（SEDP）的历史缓存具有以下功能：
### SEDPbuiltinPublicationsWriter和SEDPbuiltinPublicationsReader的历史缓存
- **数据存储与对应关系**
    - 数据类型为DiscoveredWriterData。
    - 基数与域参与者包含的数据写入器数量一一对应，每个数据写入器在参与者中对应一个描述它的数据对象，存储在SEDPbuiltinPublicationsWriter的WriterHistoryCache中。
- **数据对象操作与缓存更新**
    - 数据对象插入：每当域参与者中创建一个数据写入器时，相应数据对象插入历史缓存。
    - 数据对象修改：每当现有数据写入器的QoS被修改时，历史缓存中的对应数据对象随之修改。
    - 数据对象删除：每当域参与者中一个现有数据写入器被删除时，历史缓存中的对应数据对象被删除。
### SEDPbuiltinSubscriptionsWriter和SEDPbuiltinSubscriptionsReader的历史缓存
- **数据存储与对应关系**
    - 数据类型为DiscoveredReaderData。
    - 基数与域参与者包含的数据读取器数量一一对应，每个数据读取器在参与者中对应一个描述它的数据对象，存储在SEDPbuiltinSubscriptionsWriter的WriterHistoryCache中。
- **数据对象操作与缓存更新**
    - 数据对象插入：每当域参与者中创建一个数据读取器时，相应数据对象插入历史缓存。
    - 数据对象修改：每当现有数据读取器的QoS被修改时，历史缓存中的对应数据对象随之修改。
    - 数据对象删除：每当域参与者中一个现有数据读取器被被删除时，历史缓存中的对应数据对象被删除。
### SEDPbuiltinTopicsWriter和SEDPbuiltinTopicsReader的历史缓存
- **数据存储与对应关系**
    - 数据类型为DiscoveredTopicData。
    - 基数与域参与者创建的主题数量一一对应，每个主题在参与者中对应一个描述它的数据对象，存储在SEDPbuiltinTopicsWriter的WriterHistoryCache中。
- **数据对象操作与缓存更新**
    - 数据对象插入：每当域参与者中创建一个主题时，相应数据对象插入历史缓存。
    - 数据对象修改：每当现有主题的QoS被修改时，历史缓存中的对应数据对象随之修改。
    - 数据对象删除：每当域参与者中一个现有主题被删除时，历史缓存中的对应数据对象被删除。

## 如何解决 SEDP 协议的历史缓存一致性问题？

以下是一些可能用于解决SEDP协议历史缓存一致性问题的方法：

### 基于数据更新的一致性维护
- **数据插入一致性**
    - 在SEDP协议中，对于不同类型的内置端点（如SEDPbuiltinPublicationsWriter等），数据对象的插入与特定的操作相关联。例如，当在域参与者中创建一个数据写入器（对应SEDPbuiltinPublicationsWriter）、数据读取器（对应SEDPbuiltinSubscriptionsWriter）或主题（对应SEDPbuiltinTopicsWriter）时，会相应地在历史缓存中插入一个数据对象。这种基于明确操作的插入规则有助于确保数据在不同端点的历史缓存中以相同的逻辑被插入，从而维护一致性。
- **数据修改一致性**
    - 当现有数据写入器、读取器或主题的QoS被修改时，历史缓存中的对应数据对象也会随之修改。这要求各个端点在进行QoS修改操作时，能够准确地更新历史缓存中的相关数据。为了保证一致性，可能需要在协议层面定义统一的QoS修改通知机制，确保所有相关端点都能及时得知并正确处理修改操作，使历史缓存中的数据保持一致。
- **数据删除一致性**
    - 类似地，当域参与者中的数据写入器、读取器或主题被删除时，历史缓存中的对应数据对象也需要被删除。这需要在协议中明确删除操作的传播和执行机制，确保各个端点的历史缓存能够同步地进行数据删除操作，避免出现数据不一致的情况。

### 缓存同步机制
- **基于租约期限的同步**
    - SEDP协议可能利用租约期限来管理参与者的存在状态。当本地参与者根据远程参与者的租约期限判断其不再存在时，会重新配置与该远程参与者通信的本地端点，并相应地更新历史缓存。这种基于租约期限的机制有助于确保历史缓存中的数据与实际的参与者状态保持一致，避免对不存在的参与者相关数据的错误引用。
- **基于发现协议的同步**
    - 通过SPDP和SEDP之间的交互来实现历史缓存的同步。例如，当使用SPDP发现新的远程参与者时，本地参与者会根据相关信息配置SEDP内置端点，并在这个过程中可能涉及到历史缓存的更新操作。通过这种跨协议的交互和协调，可以保证历史缓存能够及时反映网络中参与者和端点的最新状态，从而维护一致性。

### 数据类型和格式规范
- **统一的数据类型定义**
    - SEDP协议为不同的内置端点定义了相关的数据类型（如DiscoveredWriterData、DiscoveredReaderData和DiscoveredTopicData等），这些数据类型包含了特定的信息结构和规则。通过在协议中明确规定这些数据类型，确保各个端点在处理历史缓存数据时使用相同的格式和语义，有助于减少因数据格式不一致导致的缓存一致性问题。
- **数据格式的标准化**
    - 对于存储在历史缓存中的数据，其格式可能需要遵循一定的标准。例如，对于与端点相关的数据对象的表示方式、数据对象中各个字段的编码方式等都应有明确的规范。这样可以保证不同端点在解析和处理历史缓存数据时能够得到一致的结果，维护缓存的一致性。


