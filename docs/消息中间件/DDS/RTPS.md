---
sort: 2
---

# RTPS

## 大纲

RTPS规范定义了DDS互操作性协议。对于不熟悉DDS的读者，建议首先阅读DDS规范。
- 对于RTPS新手，可以从阅读PIM（平台无关模型）的**结构**和**消息模块**开始。这些模块提供了RTPS协议角色的概述，它们与DDS实体之间的关系，以及存在哪些RTPS消息以及它们的结构。
- 对于希望探索RTPS消息交换协议的读者，可以阅读**行为模块**的第一部分。RTPS是一个相当灵活的协议，允许实现根据希望在远程端点保留多少`状态`来自定义其行为。行为模块的第一部分列出了任何符合RTPS协议的合规实现必须满足的一般要求，以保持与其他实现互操作性。
- 行为模块的第二部分定义了两种参考实现。一种参考实现维护远程端点上的完整状态，另一种则不维护任何状态。这一节可能对想要更详细理解 RTPS 消息交换协议的读者感兴趣，但对于第一次阅读的人来说，可以很容易地跳过。
- 对 RTPS 如何处理远程端点的动态发现感兴趣的读者，请参阅独立的发现模块。
- 最后，数据表示章节定义了用于与 RTPS 一起使用的数据表示机制。

## RTPS协议的概念、目的、范围和在不同网络环境中的适用性

RTPS（Real-Time Publish-Subscribe）协议的目的、范围和在不同网络环境中的适用性可以从以下几个方面来理解：

1. **目的**：
   - RTPS协议的主要目的是提供一种机制，使得不同的DDS（Data Distribution Service）实现能够在分布式系统中进行高效的实时数据交换。
   - 它旨在支持数据中心的发布-订阅通信模式，确保数据的实时分发和高效传输。

2. **范围**：
   - RTPS定义了一个互操作性线协议，它包括了消息格式、消息交换的语义、数据序列化和反序列化的方法，以及网络发现和配置的机制。
   - 它还规定了如何通过QoS（Quality of Service）策略来控制数据传输的可靠性、时间限制和资源管理。

3. **适用性**：
   - RTPS协议适用于需要实时数据交换的各种网络环境，包括但不限于工业自动化、航空航天、军事和电信领域。
   - 它特别适用于那些对延迟、带宽和可靠性有严格要求的应用场景，如实时控制系统和关键任务通信系统。
   - RTPS能够在多种网络类型上运行，包括局域网（LAN）、广域网（WAN）和互联网，同时支持多种传输层协议，如UDP和TCP。

4. **网络环境的适应性**：
   - RTPS协议设计时考虑了网络的动态性和异构性，能够适应网络参与者的加入和离开，以及网络拓扑的变化。
   - 它通过内置的发现机制支持即插即用（plug-and-play）的功能，使得新的参与者可以轻松地加入现有的DDS网络，而无需进行复杂的配置。
   - 协议还包括了对多播和单播传输的支持，以及对网络分区和不稳定性的容错能力。

总的来说，RTPS协议通过提供一种标准化的、高效的、可靠的通信机制，使得分布式实时系统中的不同DDS实现能够无缝地交换数据，无论它们运行在何种网络环境或使用何种物理传输层协议。


## 平台独立模型 (PIM)

平台独立模型（Platform Independent Model，简称PIM）是一种软件架构概念，它提供了一个抽象层，使得软件可以在不同的硬件和操作系统平台上运行而不做修改。在RTPS（Real-Time Publish-Subscribe）协议的上下文中，PIM具有特定的含义和作用：

1. **抽象层**：PIM定义了RTPS协议的核心概念和行为，而不依赖于任何特定的通信平台或操作系统。这意味着PIM提供了一个抽象的协议规范，它描述了如何实现DDS（Data Distribution Service）的互操作性线协议，而不关心底层的网络细节。

2. **跨平台通信**：通过PIM，开发者可以确保他们的RTPS实现遵循统一的标准，从而实现不同DDS实现之间的互操作性。这允许在多种网络环境和传输层协议（如UDP、TCP等）上实现RTPS协议。

3. **设计与实现分离**：PIM将协议的设计与其在特定平台上的实现分离开来。这样，协议的设计者可以专注于定义协议的行为和功能，而实现者则负责将这些抽象概念映射到具体的技术实现上。

4. **灵活性和扩展性**：PIM允许在不改变现有协议规范的情况下，通过添加新的功能和特性来扩展协议。这种设计使得RTPS协议能够适应未来的需求变化和技术进步。

在RTPS协议中，PIM包括了结构、消息、行为和发现等模块，这些模块共同定义了协议的工作原理和数据传输的规则。PIM的存在使得RTPS协议能够在不同的网络和系统环境中灵活地应用，同时保持一致性和互操作性。

### 平台独立模型 (PIM)的范围

平台独立模型（PIM）是DDSI-RTPS规范中定义的抽象模型，它描述了RTPS协议的核心概念和行为，而不依赖于任何特定的通信平台或操作系统。PIM的大纲包括以下几个主要模块：

1. **结构模块（Structure Module）**：
   - 定义了RTPS实体的结构，包括参与者（Participant）、写入者（Writer）、读取者（Reader）和历史缓存（HistoryCache）。
   - 描述了全局唯一标识符（GUID）的使用，以及如何在网络中唯一标识每个RTPS实体。

2. **消息模块（Messages Module）**：
   - 规定了RTPS消息的内容和结构，包括头部和子消息（Submessages）的格式。
   - 详细说明了各种子消息的用途，如数据（Data）、心跳（Heartbeat）、确认（AckNack）、间隙（Gap）等。

3. **行为模块（Behavior Module）**：
   - 描述了RTPS Writer和Reader之间消息交换的合法序列和时序要求。
   - 定义了如何处理各种消息，包括消息的发送、接收、确认和超时处理。

4. **发现模块（Discovery Module）**：
   - 介绍了如何在DDS域中自动发现其他参与者和端点。
   - 定义了发现机制的工作原理，包括参与者和端点的公告、发现和配置。

5. **版本控制和可扩展性（Versioning and Extensibility）**：
   - 讨论了如何处理RTPS协议的不同版本间的兼容性和扩展性。
   - 规定了如何通过添加新的子消息和参数来扩展协议，同时保持与旧版本的兼容性。

6. **实现DDS QoS和高级特性（Implementing DDS QoS and advanced DDS features）**：
   - 说明了如何使用RTPS实现DDS的服务质量（QoS）策略。
   - 描述了高级DDS特性，如内容过滤、实例状态变化、组有序访问等的实现方法。

7. **数据表示（Data Representation）**：
   - 定义了如何表示和传输用户定义的数据类型。
   - 介绍了序列化负载（SerializedPayload）的格式和表示标识符（RepresentationIdentifier）的使用。

PIM为RTPS协议提供了一个统一的框架，使得在不同的平台和环境中实现的DDS系统能够互相理解和通信。通过PIM，开发者可以确保他们的系统遵循统一的标准，从而实现不同DDS实现之间的互操作性。


### 平台独立模型 (PIM)中结构模块（Structure Module）

在RTPS协议的PIM（平台独立模型）中，结构模块（Structure Module）提供了整个协议的基础框架，定义了协议中使用的主要概念和实体。结构模块的大纲通常包括以下内容：

1. **域（Domain）**：
   - 定义了RTPS中的域概念，它代表了一个独立的通信平面，其中包含一组参与者（Participants）。

2. **参与者（Participant）**：
   - 描述了参与者的属性和功能，它是RTPS中的一个重要实体，代表了一个应用程序或服务。
   - 讨论了如何为参与者分配全局唯一标识符（GUID）。

3. **组（Group）**：
   - 介绍了组的概念，它是参与者内部的一个逻辑集合，用于组织和管理相关的读写实体。

4. **读写实体（Reader and Writer Entities）**：
   - 定义了读写实体的通用属性和它们在数据分发中的角色。
   - 描述了读写实体如何与历史缓存（HistoryCache）交互。

5. **历史缓存（HistoryCache）**：
   - 详细说明了历史缓存的作用，它是RTPS实体用来存储和管理数据变更（CacheChanges）的机制。
   - 讨论了历史缓存的容量、过期策略和访问控制。

6. **数据（Data）和实例（Instance）**：
   - 定义了数据和实例的概念，以及它们如何与读写实体交互。
   - 描述了数据的序列化和反序列化过程。

7. **更改（Change）**：
   - 介绍了更改的概念，它代表了对数据对象的创建、修改或删除操作。
   - 讨论了如何表示和处理不同类型的更改。

8. **唯一标识符（GUID）和实体ID（EntityId）**：
   - 描述了如何使用GUID和EntityId来唯一标识RTPS实体。
   - 讨论了GUID和EntityId的构造和映射规则。

9. **关联和匹配（Matching）**：
   - 定义了参与者、读者和写者之间的关联和匹配规则。
   - 讨论了如何通过主题（Topic）和数据类型（Type）来匹配读写实体。

10. **内置端点（Built-in Endpoints）**：
    - 介绍了RTPS协议内置端点的概念，如发现端点（Discovery Endpoints）和参与者消息端点（Participant Message Endpoints）。
    - 讨论了这些端点在协议中的作用和如何使用它们进行网络发现和通信。

结构模块为RTPS协议的其他部分提供了基础，确保了协议的一致性和可预测性。通过这些定义，PIM使得RTPS能够在不同的网络环境和系统平台上实现高效、可靠的数据分发。

## Stateful和Stateless

在 DDSI-RTPS 协议中，Stateful 和 Stateless 指的是 RTPS Reader 和 Writer 的两种实现方式，它们在维护状态信息方面存在差异。

**Stateless**:
*   **无状态**:  不维护与匹配的远程 Reader 或 Writer 的任何状态信息。
*   **优点**: 
    *   **可扩展性**:  适合大型系统，因为不维护状态信息，可以处理更多连接。
    *   **资源占用**:  内存占用更少。
    *   **带宽利用率**:  可能更高，因为它不会发送不需要的信息。
*   **缺点**:
    *   **性能**:  可能会牺牲一些性能，因为它需要更多时间来确定 Reader 或 Writer 的状态。
    *   **可靠性**:  严格可靠的通信不可用。
    *   **过滤**:  难以在 Writer 端进行基于内容的过滤，因为不知道每个 Reader 的过滤器信息。

**Stateful**:
*   **有状态**:  维护与每个匹配的 Reader 或 Writer 的状态信息。
*   **优点**:
    *   **性能**:  可以更快地确定 Reader 或 Writer 的状态，从而提高性能。
    *   **可靠性**:  可以保证严格可靠的通信。
    *   **过滤**:  可以在 Writer 端进行基于内容的过滤，因为知道每个 Reader 的过滤器信息。
*   **缺点**:
    *   **可扩展性**:  可扩展性较差，因为维护状态信息会占用更多内存和带宽。
    *   **资源占用**:  内存占用更多。

选择 Stateful 还是 Stateless 取决于具体的应用场景和需求。例如：
*   **如果系统规模较大，并且对可扩展性要求较高，则应选择 Stateless**。
*   **如果系统对可靠性要求较高，或者需要 Writer 端进行基于内容的过滤，则应选择 Stateful**。

- RTPS协议概述
   - 定义了一种用于DDS的互操作性线协议，目的是确保基于不同供应商实现的DDS应用能够互操作
   - 由平台独立模型（PIM）和一系列平台特定模型（PSM）组成
- PIM相关内容
   - 结构模块（Structure Module）：定义了RTPS实体的结构，包括参与者（Participant）、端点（Endpoint）、写者（Writer）、读者（Reader）等，以及它们之间的关系
   - 消息模块（Messages Module）：描述了RTPS消息的总体结构和逻辑内容，包括消息头、子消息等
   - 行为模块（Behavior Module）：描述了RTPS实体的动态行为，包括消息交换的有效序列、定时约束等
   - 发现模块（Discovery Module）：定义了RTPS发现协议，用于允许每个RTPS参与者发现其他相关参与者及其端点
- PSM相关内容
   - UDP/IP模型：定义了将协议PIM映射到UDP/IP的平台特定模型，包括对RTPS类型、消息和内置端点的映射
- 数据序列化
   - 介绍了RTPS协议中序列化应用数据的相关内容，包括SerializedPayloadHeader和Representation Identifier的定义，以及不同类型端点的SerializedPayload表示形式

